<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard | VoteMate</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f4f7fa;
      padding: 20px;
      overflow-x: hidden;
    }

    h2 {
      color: #1a237e;
    }

    .dashboard-layout {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }

    .left-panel {
      flex: 3;
    }

    .right-panel {
      flex: 1.2;
      background: #ffffff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .right-panel h3 {
      color: #2e7d32;
      margin-bottom: 15px;
      border-bottom: 2px solid #81c784;
      padding-bottom: 5px;
    }

    .past-cr-card {
      background: #f1f8e9;
      border-left: 5px solid #43a047;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .candidate-card {
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    button {
      background: #1a73e8;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 15px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover:enabled {
      background: #0c47a1;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #resultsCharts {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 25px;
    }

    .chart-panel {
      flex: 1 1 350px;
      min-width: 290px;
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    #countdown {
      font-size: 1.1em;
      font-weight: 600;
      color: #d32f2f;
      margin-bottom: 18px;
    }

    /* Winner Popup styled like given image */
    #winnerPopup {
      width: 90%;
      max-width: 750px;
      margin: 25px auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #0d6efd;
      border-right: 4px solid #d81b60;
      padding: 18px 0;
      animation: fadeIn 0.6s ease;
      text-align: center;
    }

    #winnerPopup h4 {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: #333;
    }

    .winner-row {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-top: 5px;
      text-align: center;
    }

    .winner-col {
      flex: 1;
    }

    .winner-col h5 {
      margin: 0;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .male-label {
      color: #1565c0;
    }

    .female-label {
      color: #c2185b;
    }

    .winner-col p {
      margin-top: 6px;
      font-size: 1rem;
      color: #000;
      font-weight: 500;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #confettiCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
    }
  </style>
</head>

<body>
  <h2>üéì Student Dashboard</h2>
  <h3 id="countdown"></h3>

  <div class="dashboard-layout">
    <div class="left-panel">
      <div id="electionContainer"></div>

      <div id="resultsCharts">
        <div class="chart-panel">
          <h3>üìä Male CR Results</h3>
          <canvas id="resultsChartMale" width="350" height="200"></canvas>
          <div id="winnerMale" style="margin-top:10px;font-weight:bold;"></div>
        </div>
        <div class="chart-panel">
          <h3>üìä Female CR Results</h3>
          <canvas id="resultsChartFemale" width="350" height="200"></canvas>
          <div id="winnerFemale" style="margin-top:10px;font-weight:bold;"></div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <h3>üèÜ CRs List</h3>
      <div id="pastCRContainer">Loading past winners...</div>
    </div>
  </div>

  <canvas id="confettiCanvas"></canvas>

  <script>
    // ‚úÖ Improved token handling
    let token = localStorage.getItem("token");
    const urlParams = new URLSearchParams(window.location.search);
    const urlToken = urlParams.get("token");

    if (urlToken) {
      token = urlToken;
      localStorage.setItem("token", token);
    }

    if (!token) {
      alert("Please login again.");
      window.location.href = "main.html";
    }

    let currentElectionId = null;
    let refreshInterval = null;

    const electionContainer = document.getElementById("electionContainer");
    const pastCRContainer = document.getElementById("pastCRContainer");
    const confettiCanvas = document.getElementById("confettiCanvas");

    async function loadPastCRs() {
      try {
        const res = await axios.get("http://localhost:5000/api/student/past-winners", {
          headers: { Authorization: `Bearer ${token}` }
        });

        const data = res.data;
        if (!data.length) {
          pastCRContainer.innerHTML = "<p>No past CR records found.</p>";
          return;
        }

        pastCRContainer.innerHTML = data.map(e =>
          `<div class='past-cr-card'>
             <strong>${e.election} Male CR:</strong> ${e.maleWinner}<br>
             <strong>${e.election} Female CR:</strong> ${e.femaleWinner}
           </div>`
        ).join('');
      } catch (err) {
        console.error("Error fetching past CRs:", err);
        pastCRContainer.innerHTML = "<p>‚ö†Ô∏è Unable to load past winners.</p>";
      }
    }

    async function loadActiveElection() {
      try {
        const res = await axios.get("http://localhost:5000/api/student/active-election", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const election = res.data;

        if (!election || !election.candidates) {
          electionContainer.innerHTML = "<p>No active election found.</p>";
          clearInterval(refreshInterval);
          return;
        }

        currentElectionId = election._id;
        const startTime = new Date(election.startTime);
        const endTime = new Date(startTime.getTime() + election.duration * 60000);

        let html = `<h3>üó≥Ô∏è Active Election: ${election.title}</h3>`;
        html += `<p><strong>Duration:</strong> ${election.duration} mins</p>`;

        const male = election.candidates.filter(c => c.gender === "Male");
        const female = election.candidates.filter(c => c.gender === "Female");

        html += `<h4 style='color:#0d47a1'>Vote for Male CR</h4>`;
        male.forEach(c => {
          html += `<div class='candidate-card'>
                     <strong>${c.name}</strong>
                     <button onclick="vote('${election._id}', '${c._id}', 'Male')">Vote</button>
                   </div>`;
        });

        html += `<h4 style='color:#880e4f;margin-top:25px;'>Vote for Female CR</h4>`;
        female.forEach(c => {
          html += `<div class='candidate-card'>
                     <strong>${c.name}</strong>
                     <button onclick="vote('${election._id}', '${c._id}', 'Female')">Vote</button>
                   </div>`;
        });

        electionContainer.innerHTML = html;
        startCountdown(endTime);
        loadResults();
        refreshInterval = setInterval(loadResults, 5000);
      } catch (err) {
        console.error(err);
        electionContainer.innerHTML = "<p>‚ö†Ô∏è Error loading active election.</p>";
      }
    }

    async function vote(electionId, candidateId, gender) {
      try {
        await axios.post(
          "http://localhost:5000/api/student/vote",
          { electionId, candidateId },
          { headers: { Authorization: `Bearer ${token}` } }
        );

        alert(`Vote for ${gender} CR submitted ‚úÖ`);
        const buttons = document.querySelectorAll(`button[onclick*="'${gender}'"]`);
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.textContent = "Voted";
        });
      } catch (err) {
        alert(err.response?.data?.message || "Error submitting vote");
        if (err.response?.data?.message?.includes("already voted")) {
          const buttons = document.querySelectorAll(`button[onclick*="'${gender}'"]`);
          buttons.forEach(btn => {
            btn.disabled = true;
            btn.textContent = "Voted";
          });
        }
      }
    }

    async function loadResults() {
      if (!currentElectionId) return;
      const res = await axios.get(`http://localhost:5000/api/student/results/${currentElectionId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = res.data;

      const maleCtx = document.getElementById("resultsChartMale").getContext("2d");
      const femaleCtx = document.getElementById("resultsChartFemale").getContext("2d");

      if (window.chartMale) window.chartMale.destroy();
      if (window.chartFemale) window.chartFemale.destroy();

      window.chartMale = new Chart(maleCtx, {
        type: "bar",
        data: {
          labels: data.maleCandidates.map(c => c.name),
          datasets: [{ label: "Male Votes", data: data.maleCandidates.map(c => c.votes), backgroundColor: "rgba(26,115,232,0.7)" }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      window.chartFemale = new Chart(femaleCtx, {
        type: "bar",
        data: {
          labels: data.femaleCandidates.map(c => c.name),
          datasets: [{ label: "Female Votes", data: data.femaleCandidates.map(c => c.votes), backgroundColor: "rgba(220,62,140,0.6)" }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      if (!data.isActive) {
        showWinnerPopup(data.maleWinner, data.femaleWinner);
        clearInterval(refreshInterval);
      }
    }

    function startCountdown(endTime) {
      const countdownEl = document.getElementById("countdown");
      function update() {
        const now = new Date();
        const diff = endTime - now;
        if (diff <= 0) {
          countdownEl.textContent = "‚è∞ Election ended!";
          setTimeout(() => loadResults(), 1000);
          return;
        }
        const m = Math.floor(diff / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        countdownEl.textContent = `‚è≥ Ends in ${m}:${s.toString().padStart(2, "0")} mins`;
      }
      update();
      setInterval(update, 1000);
    }

    // üé® Winner card styled like your image
    function showWinnerPopup(maleWinner, femaleWinner) {
      if (document.getElementById("winnerPopup")) return;

      const popup = document.createElement("div");
      popup.id = "winnerPopup";
      popup.innerHTML = `
        <h4>üèÜ Election Winners üéâ</h4>
        <div class="winner-row">
          <div class="winner-col">
            <h5 class="male-label">Male CR</h5>
            <p>${maleWinner?.name || "Pending"}</p>
          </div>
          <div class="winner-col">
            <h5 class="female-label">Female CR</h5>
            <p>${femaleWinner?.name || "Pending"}</p>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
      drawConfetti();
      setTimeout(() => popup.remove(), 120000);
    }

    function drawConfetti() {
      const ctx = confettiCanvas.getContext("2d");
      const W = confettiCanvas.width = confettiCanvas.offsetWidth;
      const H = confettiCanvas.height = confettiCanvas.offsetHeight;
      const particles = [];
      for (let i = 0; i < 150; i++) {
        const side = i % 2 === 0 ? "left" : "right";
        const startX = side === "left" ? 0 : W;
        const speedX = side === "left" ? Math.random() * 5 + 3 : -(Math.random() * 5 + 3);
        const color = `hsl(${Math.random() * 360}, 100%, 70%)`;
        particles.push({
          x: startX, y: H, size: Math.random() * 6 + 3,
          color, speedX, speedY: -(Math.random() * 7 + 5),
          gravity: 0.15, rotation: Math.random() * 360, opacity: 1
        });
      }
      function draw() {
        ctx.clearRect(0, 0, W, H);
        particles.forEach(p => {
          ctx.save();
          ctx.globalAlpha = p.opacity;
          ctx.translate(p.x, p.y);
          ctx.rotate((p.rotation * Math.PI) / 180);
          ctx.fillStyle = p.color;
          ctx.shadowBlur = 10;
          ctx.shadowColor = p.color;
          ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
          ctx.restore();

          p.x += p.speedX;
          p.y += p.speedY;
          p.speedY += p.gravity;
          p.rotation += 5;
          p.opacity -= 0.006;
        });
        if (particles.some(p => p.opacity > 0)) requestAnimationFrame(draw);
      }
      draw();
    }

    loadPastCRs();
    loadActiveElection();
  </script>
</body>
</html>
